<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë˜ì „ ë¸Œë ˆì´ì»¤</title>
<style>
:root {
  --bg:#0a0a12; --panel:#12121e; --border:#2a2a3e;
  --gold:#c9a84c; --gold2:#f0d080;
  --red:#e05050; --blue:#4a9eff; --green:#50c878; --purple:#9b59b6;
  --crimson:#8b0000; --blood:#cc2244; --vampur:#6a0dad;
  --text:#e8e4d8; --muted:#7a7690;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:var(--bg);
  color:var(--text);
  font-family:'Segoe UI',sans-serif;
  min-height:100vh;
  display:flex; justify-content:center; align-items:flex-start;
  padding:14px;
}
#app{width:100%;max-width:460px;}

.screen{display:none;}
.screen.active{display:block;}

/* ë²„íŠ¼ */
.btn{
  border:none; border-radius:8px;
  padding:10px 16px; font-size:13px; font-weight:700;
  cursor:pointer; transition:all .12s; font-family:inherit;
}
.btn:active{transform:scale(.95);}
.btn:disabled{opacity:.35;cursor:not-allowed;transform:none;}
.btn-gold{background:linear-gradient(135deg,#b8860b,#ffd700);color:#111;}
.btn-gold:hover:not(:disabled){filter:brightness(1.1);}
.btn-red{background:#c0392b;color:#fff;}
.btn-blue{background:#1a6ebd;color:#fff;}
.btn-green{background:#1a7a3a;color:#fff;}
.btn-gray{background:#1e1e2e;color:var(--muted);border:1px solid var(--border);}
.btn-gray:hover:not(:disabled){border-color:var(--gold);color:var(--text);}
.btn-blood{background:linear-gradient(135deg,var(--crimson),var(--blood));color:#fff;}
.btn-blood:hover:not(:disabled){filter:brightness(1.15);}

/* ë°” */
.bar-wrap{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.bar-label{font-size:11px;color:var(--muted);width:24px;}
.bar-track{flex:1;height:7px;background:#1a1a28;border-radius:4px;overflow:hidden;}
.bar-fill{height:100%;border-radius:4px;transition:width .3s;}
.bar-hp .bar-fill{background:linear-gradient(90deg,#8b1a1a,var(--red));}
.bar-hp.vampire-bar .bar-fill{background:linear-gradient(90deg,var(--crimson),var(--blood));}
.bar-mp .bar-fill{background:linear-gradient(90deg,#1a3a8b,var(--blue));}
.bar-mp.vampire-bar .bar-fill{background:linear-gradient(90deg,#3a0a4a,var(--vampur));}
.bar-exp .bar-fill{background:linear-gradient(90deg,#5a2080,var(--purple));}
.bar-val{font-size:11px;color:var(--muted);width:58px;text-align:right;}

/* â•â• íƒ€ì´í‹€ â•â• */
#screen-title{text-align:center;padding-top:24px;}
.logo{
  font-size:40px;font-weight:900;letter-spacing:2px;
  background:linear-gradient(135deg,#b8860b,#ffd700,#b8860b);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  margin-bottom:4px;
}
.logo-sub{font-size:11px;color:var(--muted);letter-spacing:4px;text-transform:uppercase;margin-bottom:36px;}
.class-row{display:flex;gap:8px;margin-bottom:20px;flex-wrap:wrap;}
.cls-card{
  flex:1;min-width:80px;background:var(--panel);border:2px solid var(--border);
  border-radius:12px;padding:14px 8px;text-align:center;cursor:pointer;transition:.2s;
}
.cls-card:hover{border-color:var(--gold);}
.cls-card.sel{border-color:var(--gold);background:#1c1808;box-shadow:0 0 16px #c9a84c33;}
.cls-card.vampire-card.sel{border-color:var(--blood);background:#1a0510;box-shadow:0 0 16px #cc224455;}
.cls-card.vampire-card:hover{border-color:var(--blood);}
.cls-icon{font-size:30px;}
.cls-name{font-size:12px;font-weight:700;color:var(--gold);margin:6px 0 3px;}
.cls-card.vampire-card .cls-name{color:var(--blood);}
.cls-desc{font-size:10px;color:var(--muted);line-height:1.5;}

/* â•â• ì „íˆ¬ â•â• */
.battle-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.stage-badge{
  background:#1c1808;border:1px solid #b8860b;
  border-radius:6px;padding:4px 12px;
  font-size:12px;font-weight:700;color:var(--gold);letter-spacing:1px;
}
.turn-badge{
  font-size:11px;padding:4px 10px;border-radius:6px;font-weight:700;
  background:#0a1a2e;border:1px solid var(--blue);color:var(--blue);
}
.turn-badge.enemy-turn{background:#2e0a0a;border-color:var(--red);color:var(--red);}

/* ì  */
.enemy-zone{display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-bottom:10px;min-height:100px;align-items:flex-end;}
.enemy-card{
  background:#160a0a;border:2px solid #3a1a1a;
  border-radius:10px;padding:8px 10px;
  text-align:center;cursor:pointer;transition:.15s;
  flex:1;min-width:70px;max-width:110px;position:relative;
}
.enemy-card:hover:not(.dead){border-color:var(--gold);}
.enemy-card.targeted{border-color:var(--red);box-shadow:0 0 12px #e0505055;}
.enemy-card.dead{opacity:.25;pointer-events:none;filter:grayscale(1);}
.e-icon{font-size:26px;}
.e-name{font-size:10px;color:var(--muted);margin:3px 0 2px;}
.e-hpbar{width:100%;height:3px;background:#2a0a0a;border-radius:2px;overflow:hidden;}
.e-hpfill{height:100%;background:var(--red);border-radius:2px;transition:width .3s;}
.e-hp{font-size:10px;color:var(--red);margin-top:2px;}
.e-status{font-size:9px;color:var(--purple);}

/* í”Œë ˆì´ì–´ */
.player-card{
  background:#0a0d18;border:1px solid #1e2a3a;
  border-radius:10px;padding:12px 14px;margin-bottom:10px;
  transition:border-color .3s;
}
.player-card.vampire-theme{background:#0d0608;border-color:#2a1020;}
.player-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
.player-left{display:flex;align-items:center;gap:10px;}
.p-avatar{font-size:30px;}
.p-name{font-weight:700;font-size:14px;}
.p-lv{font-size:11px;color:var(--muted);}
.p-stats-right{font-size:11px;color:var(--muted);text-align:right;line-height:2;}
.stat-val{color:var(--gold);font-weight:700;}
.stat-val.blood-val{color:var(--blood);}

/* í˜ˆê¸° ê²Œì´ì§€ (ë±€íŒŒì´ì–´ ì „ìš©) */
.blood-bar-wrap{
  display:flex;align-items:center;gap:8px;margin-bottom:5px;
}
.blood-bar-track{
  flex:1;height:9px;background:#1a0808;border-radius:4px;overflow:hidden;
  border:1px solid #3a1020;
}
.blood-bar-fill{
  height:100%;border-radius:4px;
  background:linear-gradient(90deg,#4a0010,#cc2244,#ff6688);
  transition:width .4s;
  box-shadow:0 0 6px #cc224488;
}
.blood-val{font-size:11px;color:var(--blood);width:58px;text-align:right;font-weight:700;}
.blood-label{font-size:11px;color:var(--blood);width:24px;font-weight:700;}

/* ìŠ¤í‚¬ ê·¸ë¦¬ë“œ */
.skills-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px;}
.skill-btn{
  background:#0e0e1a;border:1px solid var(--border);
  border-radius:9px;padding:9px 10px;
  cursor:pointer;text-align:left;transition:.15s;
  display:flex;align-items:center;gap:8px;
  font-family:inherit;color:var(--text);
}
.skill-btn:hover:not(:disabled){border-color:var(--gold);background:#161620;}
.skill-btn.vampire-skill:hover:not(:disabled){border-color:var(--blood);background:#1a0810;}
.skill-btn:disabled{opacity:.38;cursor:not-allowed;}
.sk-icon{font-size:20px;flex-shrink:0;}
.sk-info{flex:1;min-width:0;}
.sk-name{font-size:12px;font-weight:700;}
.sk-meta{font-size:10px;color:var(--muted);}
.sk-cd{font-size:10px;color:var(--red);}
.sk-preview{font-size:10px;color:var(--blue);}
.sk-preview.blood-preview{color:var(--blood);}

/* ì•¡ì…˜ í–‰ */
.action-row{display:flex;gap:6px;margin-bottom:8px;}
.action-row .btn{flex:1;padding:9px 6px;font-size:12px;line-height:1.4;}

/* ë¡œê·¸ */
.log-box{
  background:#080810;border:1px solid var(--border);
  border-radius:8px;padding:8px 10px;
  height:90px;overflow-y:auto;font-size:11px;line-height:1.8;
}
.log-box::-webkit-scrollbar{width:3px;}
.log-box::-webkit-scrollbar-thumb{background:var(--border);}
.log-p{color:var(--blue);}
.log-e{color:var(--red);}
.log-s{color:var(--gold);font-weight:700;}
.log-h{color:var(--green);}
.log-x{color:var(--purple);}
.log-v{color:var(--blood);font-weight:700;}

/* í¡í˜ˆ í”Œë¡œíŒ… */
@keyframes floatHeal{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-28px)}}
.float-heal{
  position:fixed;
  font-size:13px;font-weight:700;pointer-events:none;
  color:#ff6688;
  animation:floatHeal 1s ease forwards;z-index:30;white-space:nowrap;
  text-shadow:0 0 8px #cc224488;
}

/* â•â• ìƒì  â•â• */
#screen-shop{padding-top:8px;}
.shop-header{
  display:flex;justify-content:space-between;align-items:center;
  background:#1c1808;border:1px solid #b8860b;
  border-radius:10px;padding:12px 16px;margin-bottom:10px;
}
.shop-title{font-size:20px;font-weight:900;color:var(--gold);}
.shop-gold{font-size:15px;font-weight:700;color:var(--gold);}
.shop-player-bar{
  background:var(--panel);border:1px solid var(--border);
  border-radius:10px;padding:10px 14px;margin-bottom:10px;
  font-size:11px;color:var(--muted);line-height:2;
}
.shop-sec{font-size:10px;font-weight:700;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin:10px 0 6px;}
.shop-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-bottom:10px;}
.shop-item{
  background:#0e0e1a;border:1px solid var(--border);
  border-radius:10px;padding:10px;transition:.15s;
}
.shop-item.is-equipped{border-color:var(--green);background:#091409;}
.shop-item.no-gold{opacity:.45;}
.si-head{display:flex;align-items:center;gap:8px;margin-bottom:5px;}
.si-icon{font-size:22px;}
.si-name{font-size:12px;font-weight:700;line-height:1.3;}
.si-slot{font-size:10px;color:var(--muted);}
.si-stat{font-size:11px;color:var(--blue);margin-bottom:6px;}
.si-foot{display:flex;justify-content:space-between;align-items:center;gap:4px;}
.si-price{font-size:12px;color:var(--gold);font-weight:700;}
.potion-row{display:flex;gap:8px;margin-bottom:10px;}
.pot-card{
  flex:1;background:#0e0e1a;border:1px solid var(--border);
  border-radius:10px;padding:10px;text-align:center;
}
.pot-icon{font-size:24px;margin-bottom:4px;}
.pot-name{font-size:12px;font-weight:700;margin-bottom:2px;}
.pot-eff{font-size:10px;color:var(--muted);margin-bottom:4px;}
.pot-cnt{font-size:11px;color:var(--muted);margin-bottom:6px;}

/* â•â• ë ˆë²¨ì—… ì˜¤ë²„ë ˆì´ â•â• */
.overlay{position:fixed;inset:0;background:#000b;display:none;align-items:center;justify-content:center;z-index:100;}
.overlay-box{
  background:linear-gradient(135deg,#14082a,#080e20);
  border:2px solid var(--purple);border-radius:16px;
  padding:28px 32px;text-align:center;
  box-shadow:0 0 40px #9b59b644;max-width:290px;width:90%;
}
@keyframes popIn{0%{transform:scale(.6);opacity:0}70%{transform:scale(1.06)}100%{transform:scale(1);opacity:1}}
.overlay-box{animation:popIn .35s ease forwards;}

/* â•â• ê²°ê³¼ â•â• */
#screen-result{text-align:center;padding-top:20px;}
.result-big{font-size:38px;font-weight:900;margin-bottom:6px;}
.result-win{color:var(--gold);}
.result-lose{color:var(--red);}
.result-card{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px;margin:14px 0;text-align:left;}
.r-row{display:flex;justify-content:space-between;padding:4px 0;font-size:13px;}
.r-val{color:var(--gold);font-weight:700;}

/* í”Œë¡œíŒ… ë°ë¯¸ì§€ */
@keyframes floatUp{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-32px)}}
.float-dmg{
  position:absolute;top:2px;left:50%;transform:translateX(-50%);
  font-size:15px;font-weight:700;pointer-events:none;
  animation:floatUp .85s ease forwards;z-index:20;white-space:nowrap;
}
@keyframes shakeX{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.do-shake{animation:shakeX .25s ease;}

@keyframes endingGlow{0%,100%{text-shadow:0 0 20px #c9a84c88}50%{text-shadow:0 0 40px #ffd700cc,0 0 80px #c9a84c55}}
#ending-title{animation:endingGlow 2s ease infinite;}

/* í˜ˆê¸° ì¶©ì „ ê¸€ë¡œìš° */
@keyframes bloodPulse{0%,100%{box-shadow:0 0 0 #cc224400}50%{box-shadow:0 0 14px #cc224466}}
.blood-ready{animation:bloodPulse 1.2s ease infinite;}

/* í˜ˆê¸° ìŠ¤í‚¬ íŠ¹ë³„ í…Œë‘ë¦¬ */
.skill-btn.blood-skill-available{
  border-color:#cc2244;
  box-shadow:0 0 8px #cc224444;
}

/* â•â• íŠœí† ë¦¬ì–¼ â•â• */
#screen-tutorial{padding-top:8px;}
.tut-title{font-size:20px;font-weight:900;color:var(--gold);margin-bottom:14px;}
.tut-tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;}
.tut-tab{
  padding:6px 12px;border-radius:20px;font-size:11px;font-weight:700;
  border:1px solid var(--border);background:var(--panel);color:var(--muted);
  cursor:pointer;transition:.15s;
}
.tut-tab:hover{border-color:var(--gold);color:var(--text);}
.tut-tab.active{background:#1c1808;border-color:var(--gold);color:var(--gold);}
.tut-page{display:none;}
.tut-page.active{display:block;}
.tut-section{
  background:var(--panel);border:1px solid var(--border);
  border-radius:10px;padding:12px 14px;margin-bottom:8px;
}
.tut-section-title{
  font-size:12px;font-weight:700;color:var(--gold);
  margin-bottom:8px;display:flex;align-items:center;gap:6px;
}
.tut-row{
  display:flex;align-items:flex-start;gap:10px;
  padding:6px 0;border-bottom:1px solid #1a1a2a;font-size:12px;line-height:1.6;
}
.tut-row:last-child{border-bottom:none;padding-bottom:0;}
.tut-icon{font-size:18px;flex-shrink:0;width:24px;text-align:center;margin-top:1px;}
.tut-text{flex:1;color:var(--muted);}
.tut-text strong{color:var(--text);}
.tut-text .hl{color:var(--gold);font-weight:700;}
.tut-text .hl-red{color:var(--red);font-weight:700;}
.tut-text .hl-blue{color:var(--blue);font-weight:700;}
.tut-text .hl-green{color:var(--green);font-weight:700;}
.tut-text .hl-blood{color:var(--blood);font-weight:700;}
.tut-tip{
  background:#0a0d18;border:1px solid #1a3a6a;border-radius:8px;
  padding:9px 12px;margin-top:8px;font-size:11px;color:#6a9ecc;line-height:1.7;
}
.tut-tip::before{content:'ğŸ’¡ ';}
.class-compare{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:6px;}
.cc-card{background:#0a0a14;border:1px solid var(--border);border-radius:8px;padding:8px 10px;}
.cc-name{font-size:12px;font-weight:700;margin-bottom:4px;}
.cc-stat{font-size:10px;color:var(--muted);line-height:1.9;}
</style>
</head>
<body>
<div id="app">

<!-- ë ˆë²¨ì—… ì˜¤ë²„ë ˆì´ -->
<div class="overlay" id="lu-overlay">
  <div class="overlay-box">
    <div style="font-size:36px">â¬†ï¸</div>
    <div style="font-size:20px;font-weight:900;color:var(--purple);margin:4px 0">LEVEL UP!</div>
    <div style="font-size:44px;font-weight:900;color:var(--gold)" id="lu-lv">2</div>
    <div style="font-size:13px;color:var(--muted);margin:10px 0 18px;line-height:2" id="lu-stats"></div>
    <button class="btn btn-gold" style="width:100%" onclick="closeLu()">ê³„ì†!</button>
  </div>
</div>

<!-- íƒ€ì´í‹€ -->
<div class="screen active" id="screen-title">
  <div class="logo">DUNGEON<br>BREAKER</div>
  <div class="logo-sub">Turn Based RPG</div>
  <p style="font-size:12px;color:var(--muted);margin-bottom:12px;">ì§ì—… ì„ íƒ</p>
  <div class="class-row" id="class-row"></div>
  <div style="display:flex;gap:8px;">
    <button class="btn btn-gold" style="flex:1;padding:14px;font-size:15px" onclick="startGame()">ëª¨í—˜ ì‹œì‘!</button>
    <button class="btn btn-gray" style="padding:14px 16px;font-size:13px" onclick="showScreen('tutorial')">ğŸ“– ë„ì›€ë§</button>
  </div>
</div>

<!-- íŠœí† ë¦¬ì–¼ -->
<div class="screen" id="screen-tutorial">
  <div class="tut-title">ğŸ“– ê²Œì„ ê°€ì´ë“œ</div>

  <div class="tut-tabs">
    <div class="tut-tab active" onclick="switchTutTab(0)">ê¸°ë³¸ ì „íˆ¬</div>
    <div class="tut-tab" onclick="switchTutTab(1)">ìŠ¤íƒ¯ & ì„±ì¥</div>
    <div class="tut-tab" onclick="switchTutTab(2)">ì§ì—… ì†Œê°œ</div>
    <div class="tut-tab" onclick="switchTutTab(3)">ğŸ§› ë±€íŒŒì´ì–´</div>
  </div>

  <!-- íƒ­0: ê¸°ë³¸ ì „íˆ¬ -->
  <div class="tut-page active" id="tut-0">
    <div class="tut-section">
      <div class="tut-section-title">âš” ì „íˆ¬ íë¦„</div>
      <div class="tut-row"><div class="tut-icon">1ï¸âƒ£</div><div class="tut-text">ì  ì¹´ë“œë¥¼ <strong>í´ë¦­</strong>í•´ ê³µê²© ëŒ€ìƒì„ ì§€ì •í•©ë‹ˆë‹¤. ë¹¨ê°„ í…Œë‘ë¦¬ê°€ í˜„ì¬ íƒ€ê²Ÿì…ë‹ˆë‹¤.</div></div>
      <div class="tut-row"><div class="tut-icon">2ï¸âƒ£</div><div class="tut-text">í–‰ë™ì„ ì„ íƒí•˜ë©´ <span class="hl">ë‚´ í„´</span>ì´ ëë‚˜ê³  ì ì´ ì°¨ë¡€ëŒ€ë¡œ ê³µê²©í•©ë‹ˆë‹¤.</div></div>
      <div class="tut-row"><div class="tut-icon">3ï¸âƒ£</div><div class="tut-text">ëª¨ë“  ì ì„ ì²˜ì¹˜í•˜ë©´ ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´! <span class="hl">ìƒì </span>ì—ì„œ ì¥ë¹„ì™€ í¬ì…˜ì„ êµ¬ë§¤í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div></div>
      <div class="tut-row"><div class="tut-icon">4ï¸âƒ£</div><div class="tut-text">HPê°€ 0ì´ ë˜ë©´ <span class="hl-red">ê²Œì„ ì˜¤ë²„</span>. ì´ <span class="hl">20 ìŠ¤í…Œì´ì§€</span>ë¥¼ í´ë¦¬ì–´í•˜ë©´ ì—”ë”©ì…ë‹ˆë‹¤.</div></div>
      <div class="tut-tip">HPì™€ MPëŠ” ìŠ¤í…Œì´ì§€ê°€ ë„˜ì–´ê°€ë„ ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤. ìƒì ì—ì„œ í¬ì…˜ì„ ì˜ í™œìš©í•˜ì„¸ìš”!</div>
    </div>

    <div class="tut-section">
      <div class="tut-section-title">ğŸ® í–‰ë™ ì„ íƒì§€</div>
      <div class="tut-row"><div class="tut-icon">âš”</div><div class="tut-text"><strong>ê¸°ë³¸ ê³µê²©</strong> â€” ATKÃ—0.8 ë°ë¯¸ì§€. MPë¥¼ ì†ŒëŸ‰ íšŒë³µí•©ë‹ˆë‹¤. ì–¸ì œë‚˜ ì‚¬ìš© ê°€ëŠ¥.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ›¡</div><div class="tut-text"><strong>ë°©ì–´</strong> â€” ë‹¤ìŒ ì  í„´ê¹Œì§€ DEF +8. ê°•ì  ì•ì—ì„œ íš¨ê³¼ì ì…ë‹ˆë‹¤.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ§ª</div><div class="tut-text"><strong>HP í¬ì…˜</strong> â€” ìµœëŒ€ HPì˜ 40% ì¦‰ì‹œ íšŒë³µ. ìƒì ì—ì„œ 20Gì— êµ¬ë§¤ ê°€ëŠ¥.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ’§</div><div class="tut-text"><strong>MP í¬ì…˜</strong> â€” ìµœëŒ€ MPì˜ 50% ì¦‰ì‹œ íšŒë³µ. ìƒì ì—ì„œ 15Gì— êµ¬ë§¤ ê°€ëŠ¥.</div></div>
      <div class="tut-row"><div class="tut-icon">âœ¨</div><div class="tut-text"><strong>ìŠ¤í‚¬</strong> â€” MPë¥¼ ì†Œëª¨í•´ ê°•ë ¥í•œ íš¨ê³¼ ë°œë™. ì‚¬ìš© í›„ ì¿¨ë‹¤ìš´ì´ ìƒê¹ë‹ˆë‹¤.</div></div>
      <div class="tut-tip">ìŠ¤í‚¬ ë²„íŠ¼ì— í‘œì‹œë˜ëŠ” <span style="color:var(--blue)">"ì˜ˆìƒ DMG"</span>ëŠ” í˜„ì¬ íƒ€ê²Ÿ ê¸°ì¤€ ì¶”ì •ì¹˜ì…ë‹ˆë‹¤.</div>
    </div>

    <div class="tut-section">
      <div class="tut-section-title">ğŸ‘¿ ë³´ìŠ¤ ìŠ¤í…Œì´ì§€</div>
      <div class="tut-row"><div class="tut-icon">âš </div><div class="tut-text">5, 10, 15, 20 ìŠ¤í…Œì´ì§€ëŠ” <span class="hl-red">BOSS</span> ìŠ¤í…Œì´ì§€ì…ë‹ˆë‹¤. ê°•ë ¥í•œ ì ì´ ì¡°í•©ìœ¼ë¡œ ë“±ì¥í•©ë‹ˆë‹¤.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ“ˆ</div><div class="tut-text">ìŠ¤í…Œì´ì§€ê°€ ë†’ì•„ì§ˆìˆ˜ë¡ ëª¨ë“  ì ì˜ HPÂ·ATKÂ·DEFê°€ <span class="hl">ìŠ¤ì¼€ì¼ ìƒìŠ¹</span>í•©ë‹ˆë‹¤.</div></div>
    </div>
  </div>

  <!-- íƒ­1: ìŠ¤íƒ¯ & ì„±ì¥ -->
  <div class="tut-page" id="tut-1">
    <div class="tut-section">
      <div class="tut-section-title">ğŸ“Š ê¸°ë³¸ ìŠ¤íƒ¯</div>
      <div class="tut-row"><div class="tut-icon">â¤</div><div class="tut-text"><strong>HP</strong> â€” 0ì´ ë˜ë©´ ê²Œì„ ì˜¤ë²„. í¬ì…˜ì´ë‚˜ í¡í˜ˆë¡œ íšŒë³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ’œ</div><div class="tut-text"><strong>MP</strong> â€” ìŠ¤í‚¬ ì‚¬ìš©ì— ì†Œëª¨ë©ë‹ˆë‹¤. ê¸°ë³¸ ê³µê²© ì‹œ ì†ŒëŸ‰ íšŒë³µ.</div></div>
      <div class="tut-row"><div class="tut-icon">âš”</div><div class="tut-text"><strong>ATK</strong> â€” ê³µê²©ë ¥. ì¥ë¹„Â·ë²„í”„ë¡œ ì¦ê°€. ìŠ¤í‚¬ ë°ë¯¸ì§€ ê³„ì‚°ì˜ ê¸°ì¤€ì…ë‹ˆë‹¤.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ›¡</div><div class="tut-text"><strong>DEF</strong> â€” ë°©ì–´ë ¥. ì ì˜ ê³µê²© ë°ë¯¸ì§€ë¥¼ ì¤„ì…ë‹ˆë‹¤. (ì‹¤ì œ ê°ì†Œ = DEF-2)</div></div>
      <div class="tut-tip">ë°ë¯¸ì§€ ê³µì‹: <span class="hl">ATK Ã— ë°°ìœ¨ âˆ’ max(0, DEFâˆ’2) + ëœë¤(-3~+4)</span><br>ë°©ì–´ë ¥ì´ ë†’ì„ìˆ˜ë¡ ìœ ë¦¬í•˜ì§€ë§Œ ì™„ë²½íˆ ë§‰ì„ ìˆ˜ëŠ” ì—†ìŠµë‹ˆë‹¤.</div>
    </div>

    <div class="tut-section">
      <div class="tut-section-title">â­ ë ˆë²¨ì—…</div>
      <div class="tut-row"><div class="tut-icon">ğŸ”º</div><div class="tut-text">ì ì„ ì²˜ì¹˜í•˜ë©´ <span class="hl">ê²½í—˜ì¹˜(EXP)</span>ë¥¼ íšë“í•©ë‹ˆë‹¤. EXP ë°”ê°€ ê°€ë“ ì°¨ë©´ ë ˆë²¨ì—…!</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ’ª</div><div class="tut-text">ë ˆë²¨ì—… ì‹œ <strong>HPÂ·MPÂ·ATKÂ·DEF</strong>ê°€ ì§ì—…ë³„ ì„±ì¥ì¹˜ë§Œí¼ ì˜¤ë¦…ë‹ˆë‹¤.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ“ˆ</div><div class="tut-text">ë ˆë²¨ì—…ì— í•„ìš”í•œ EXPëŠ” ë§¤ë²ˆ <span class="hl">1.4ë°°</span>ì”© ì¦ê°€í•©ë‹ˆë‹¤.</div></div>
    </div>

    <div class="tut-section">
      <div class="tut-section-title">ğŸ›’ ì¥ë¹„ ì‹œìŠ¤í…œ</div>
      <div class="tut-row"><div class="tut-icon">ğŸ—¡ï¸</div><div class="tut-text"><strong>ë¬´ê¸°</strong> â€” ATK ì¦ê°€. ë‚¡ì€ ê²€ â†’ ê°•ì²  ê²€ â†’ ë§ˆë²• ê²€ ìˆœìœ¼ë¡œ ê°•ë ¥í•©ë‹ˆë‹¤.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ›¡</div><div class="tut-text"><strong>ë°©ì–´êµ¬</strong> â€” DEF ì¦ê°€. ê°€ì£½ ê°‘ì˜· â†’ ì‚¬ìŠ¬ ê°‘ì˜· â†’ íŒê¸ˆ ê°‘ì˜·.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ’</div><div class="tut-text"><strong>ë°˜ì§€Â·ëª©ê±¸ì´</strong> â€” ATKì™€ DEFë¥¼ ë™ì‹œì— ì˜¬ë ¤ì£¼ëŠ” ë³´ì¡° ì¥ë¹„.</div></div>
      <div class="tut-tip">í•œ ë²ˆ êµ¬ë§¤í•œ ì¥ë¹„ëŠ” ì˜êµ¬ ë³´ìœ í•©ë‹ˆë‹¤. ê°™ì€ ìŠ¬ë¡¯ ì¥ë¹„ë¥¼ ìƒˆë¡œ ì‚¬ë©´ ìë™ êµì²´ë©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <!-- íƒ­2: ì§ì—… ì†Œê°œ -->
  <div class="tut-page" id="tut-2">
    <div class="tut-section">
      <div class="tut-section-title">âš”ï¸ ì „ì‚¬ â€” ê· í˜•ì¡íŒ íƒ±ì»¤</div>
      <div class="tut-row"><div class="tut-icon">ğŸ“‹</div><div class="tut-text">HP 150 Â· ATK 20 Â· DEF 10 Â· MP 40<br>ë†’ì€ HPì™€ DEFë¡œ ì˜¤ë˜ ë²„í‹°ëŠ” íƒ€ì….</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸŒŸ</div><div class="tut-text"><strong>ê°•íƒ€</strong> Â· <strong>ë°©íŒ¨ëŒì§„</strong> Â· <strong>íšŒì˜¤ë¦¬</strong>(ì „ì²´) Â· <strong>ì „íˆ¬í•¨ì„±</strong>(ATK ë²„í”„)</div></div>
      <div class="tut-tip">ë°©ì–´ + ì „íˆ¬í•¨ì„± ì½¤ë³´ë¡œ ATKë¥¼ ìŒ“ì€ ë’¤ ê°•íƒ€ë¡œ í­ë”œí•˜ëŠ” ê²ƒì´ íš¨ê³¼ì ì…ë‹ˆë‹¤.</div>
    </div>

    <div class="tut-section">
      <div class="tut-section-title">ğŸ”® ë§ˆë²•ì‚¬ â€” ê³ í™”ë ¥ ë”œëŸ¬</div>
      <div class="tut-row"><div class="tut-icon">ğŸ“‹</div><div class="tut-text">HP 90 Â· ATK 10 Â· DEF 3 Â· MP 120<br>ë‚®ì€ ì²´ë ¥ì´ì§€ë§Œ ì••ë„ì ì¸ ìŠ¤í‚¬ ë°ë¯¸ì§€.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸŒŸ</div><div class="tut-text"><strong>íŒŒì´ì–´ë³¼</strong>(ATKÃ—3.5) Â· <strong>ë¸”ë¦¬ìë“œ</strong>(ì „ì²´) Â· <strong>ë²ˆê°œ</strong>(ATKÃ—5.0) Â· <strong>ë§ˆë‚˜í¡ìˆ˜</strong>(MP íšŒë³µ)</div></div>
      <div class="tut-tip">HPê°€ ë‚®ì•„ ë§ìœ¼ë©´ ìœ„í—˜í•©ë‹ˆë‹¤. í¬ì…˜ì„ ë„‰ë„‰íˆ í™•ë³´í•˜ê³  ë§ˆë‚˜í¡ìˆ˜ë¡œ MPë¥¼ ìˆœí™˜ì‹œí‚¤ì„¸ìš”.</div>
    </div>

    <div class="tut-section">
      <div class="tut-section-title">ğŸ—¡ï¸ ë„ì  â€” ê³ ì† ì•”ì‚´ì</div>
      <div class="tut-row"><div class="tut-icon">ğŸ“‹</div><div class="tut-text">HP 100 Â· ATK 18 Â· DEF 5 Â· MP 70<br>ë¹ ë¥¸ ì¿¨ë‹¤ìš´ê³¼ ë…Â·íšŒí”¼ íŠ¹ìˆ˜ ê¸°ìˆ .</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸŒŸ</div><div class="tut-text"><strong>ì´ì¤‘ì°Œë¥´ê¸°</strong>(2íƒ€) Â· <strong>ë…ë‹¨ê²€</strong>(ì§€ì† í”¼í•´) Â· <strong>ì—°ë§‰íƒ„</strong>(50% íšŒí”¼) Â· <strong>ì•”ì‚´</strong>(ATKÃ—6.0)</div></div>
      <div class="tut-tip">ì´ì¤‘ì°Œë¥´ê¸°ëŠ” ì¿¨ë‹¤ìš´ì´ 1í„´ìœ¼ë¡œ ë§¤ìš° ì§§ìŠµë‹ˆë‹¤. ë…ì„ ê±¸ê³  ì—°ë§‰íƒ„ìœ¼ë¡œ í”¼í•´ë¥¼ ì¤„ì´ëŠ” ê²ƒì´ í•µì‹¬.</div>
    </div>
  </div>

  <!-- íƒ­3: ë±€íŒŒì´ì–´ -->
  <div class="tut-page" id="tut-3">
    <div class="tut-section">
      <div class="tut-section-title">ğŸ§› ë±€íŒŒì´ì–´ â€” í¡í˜ˆ íŠ¹ìˆ˜ ì§ì—…</div>
      <div class="tut-row"><div class="tut-icon">ğŸ“‹</div><div class="tut-text">HP 110 Â· ATK 19 Â· DEF 6 Â· MP 80<br>ê³µê²©ê³¼ í”¼ê²©ìœ¼ë¡œ <span class="hl-blood">í˜ˆê¸°</span>ë¥¼ ì¶©ì „í•˜ëŠ” ë…íŠ¹í•œ ì§ì—….</div></div>
      <div class="tut-row"><div class="tut-icon">âš </div><div class="tut-text">ì¼ë°˜ ì§ì—… ì¤‘ê°„ ìˆ˜ì¤€ì˜ ìŠ¤íƒ¯ì´ì§€ë§Œ, í¡í˜ˆë¡œ <strong>ìê°€ íšŒë³µ</strong>ì´ ê°€ëŠ¥í•´ ì§€ì†ì „ì— ê°•í•©ë‹ˆë‹¤.</div></div>
    </div>

    <div class="tut-section">
      <div class="tut-section-title">ğŸ©¸ í˜ˆê¸°(Blood) ì‹œìŠ¤í…œ</div>
      <div class="tut-row"><div class="tut-icon">ğŸ©¸</div><div class="tut-text"><strong>í˜ˆê¸° ê²Œì´ì§€</strong>ëŠ” ë±€íŒŒì´ì–´ ì „ìš© 3ë²ˆì§¸ ìì›ì…ë‹ˆë‹¤. ìµœëŒ€ 100 (ë ˆë²¨ì—… ì‹œ +10).</div></div>
      <div class="tut-row"><div class="tut-icon">âš”</div><div class="tut-text"><span class="hl-blood">ê¸°ë³¸ ê³µê²©</span> ì‹œ í”¼í•´ëŸ‰ì˜ <span class="hl">10%</span> í˜ˆê¸° ì¶©ì „.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ©¹</div><div class="tut-text"><span class="hl-blood">í”¼ê²©</span> ì‹œ ë°›ì€ í”¼í•´ì˜ <span class="hl">30%</span> í˜ˆê¸° ì¶©ì „. ë§ì„ìˆ˜ë¡ ê°•í•´ì§‘ë‹ˆë‹¤!</div></div>
      <div class="tut-row"><div class="tut-icon">âœ¨</div><div class="tut-text">í˜ˆê¸° ìŠ¤í‚¬ ì‚¬ìš© ì‹œ ì†Œëª¨í•©ë‹ˆë‹¤. ê²Œì´ì§€ê°€ <span class="hl">50 ì´ìƒ</span>ì´ë©´ ë¶‰ì€ ê¸€ë¡œìš°ê°€ í™œì„±í™”ë©ë‹ˆë‹¤.</div></div>
      <div class="tut-tip">í˜ˆê¸°ëŠ” ê³µê²©ë³´ë‹¤ <strong>í”¼ê²© ì‹œ ë” ë¹ ë¥´ê²Œ</strong> ì¶©ì „ë©ë‹ˆë‹¤. ìœ„ê¸° ìƒí™©ì— í˜ˆê¸°ê°€ ìŒ“ì´ë©´ ë¶ˆì‚¬ì˜ í”¼ë¡œ ì—­ì „ì„ ë…¸ë¦¬ì„¸ìš”!</div>
    </div>

    <div class="tut-section">
      <div class="tut-section-title">ğŸŒŸ ë±€íŒŒì´ì–´ ìŠ¤í‚¬</div>
      <div class="tut-row"><div class="tut-icon">ğŸ©¸</div><div class="tut-text"><strong>í¡í˜ˆ</strong> (MP 12 Â· ì¿¨2) â€” ATKÃ—2.0 ë‹¨ì¼ ê³µê²©. í”¼í•´ì˜ <span class="hl-blood">40%</span>ë¥¼ HPë¡œ í¡ìˆ˜.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ¦‡</div><div class="tut-text"><strong>ë°•ì¥ êµ°ë‹¨</strong> (MP 24 Â· ì¿¨4) â€” ATKÃ—1.2 ì „ì²´ ê³µê²©. ê° ì ì—ê²Œ ì…íŒ í”¼í•´ì˜ <span class="hl-blood">30%</span> í¡ìˆ˜.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸ’¥</div><div class="tut-text"><strong>í˜ˆê¸° í­ë°œ</strong> (MP 20 Â· ì¿¨4 Â· <span class="hl-blood">í˜ˆê¸° 50</span>) â€” í˜ˆê¸°ë¥¼ ì†Œëª¨í•´ ì „ì²´ì— ATKÃ—1.4 ê°•ë ¥ ê³µê²©.</div></div>
      <div class="tut-row"><div class="tut-icon">ğŸŒ‘</div><div class="tut-text"><strong>ë¶ˆì‚¬ì˜ í”¼</strong> (ì¿¨8 Â· <span class="hl-blood">í˜ˆê¸° 70</span>) â€” í˜ˆê¸°ë¥¼ ì†Œëª¨í•´ ìµœëŒ€ HPì˜ <span class="hl-green">60%</span>ë¥¼ ì¦‰ì‹œ íšŒë³µ!</div></div>
      <div class="tut-tip">ë¶ˆì‚¬ì˜ í”¼ëŠ” MP ì†Œëª¨ê°€ ì—†ëŠ” ëŒ€ì‹  í˜ˆê¸° 70ì´ í•„ìš”í•©ë‹ˆë‹¤. ì¿¨íƒ€ì„ë„ ê¸¸ê¸° ë•Œë¬¸ì— íƒ€ì´ë°ì„ ì˜ ê³¨ë¼ì•¼ í•©ë‹ˆë‹¤.</div>
    </div>
  </div>

  <button class="btn btn-gray" style="width:100%;padding:13px;font-size:13px;margin-top:4px" onclick="showScreen('title')">â† íƒ€ì´í‹€ë¡œ ëŒì•„ê°€ê¸°</button>
</div>

<!-- ì „íˆ¬ -->
<div class="screen" id="screen-battle">
  <div class="battle-top">
    <div class="stage-badge" id="stage-badge">STAGE 1</div>
    <div id="turn-badge" class="turn-badge">ë‚´ í„´</div>
    <div style="font-size:12px;color:var(--muted)">Lv<span id="hud-lv">1</span></div>
  </div>

  <div class="enemy-zone" id="enemy-zone"></div>

  <div class="player-card" id="player-card">
    <div class="player-top">
      <div class="player-left">
        <div class="p-avatar" id="p-avatar">âš”ï¸</div>
        <div>
          <div class="p-name" id="p-name">ì „ì‚¬</div>
          <div class="p-lv">Lv <span id="p-lv">1</span></div>
        </div>
      </div>
      <div class="p-stats-right">
        ATK <span class="stat-val" id="p-atk">-</span>
        DEF <span class="stat-val" id="p-def">-</span>
      </div>
    </div>
    <div class="bar-wrap bar-hp" id="hp-bar-wrap">
      <div class="bar-label">HP</div>
      <div class="bar-track bar-hp" id="hp-track"><div class="bar-fill" id="bar-hp" style="width:100%"></div></div>
      <div class="bar-val"><span id="p-hp">-</span>/<span id="p-mhp">-</span></div>
    </div>
    <div class="bar-wrap bar-mp" id="mp-bar-wrap">
      <div class="bar-label" id="mp-label">MP</div>
      <div class="bar-track bar-mp" id="mp-track"><div class="bar-fill" id="bar-mp" style="width:100%"></div></div>
      <div class="bar-val"><span id="p-mp">-</span>/<span id="p-mmp">-</span></div>
    </div>
    <!-- í˜ˆê¸° ê²Œì´ì§€ (ë±€íŒŒì´ì–´ ì „ìš©) -->
    <div id="blood-bar-container" style="display:none">
      <div class="blood-bar-wrap">
        <div class="blood-label">ğŸ©¸</div>
        <div class="blood-bar-track" id="blood-track">
          <div class="blood-bar-fill" id="bar-blood" style="width:0%"></div>
        </div>
        <div class="blood-val"><span id="p-blood">0</span>/<span id="p-mblood">100</span></div>
      </div>
    </div>
    <div class="bar-wrap">
      <div class="bar-label">EXP</div>
      <div class="bar-track bar-exp"><div class="bar-fill" id="bar-exp" style="width:0%"></div></div>
      <div class="bar-val" id="exp-val" style="font-size:10px">0/30</div>
    </div>
  </div>

  <div class="skills-grid" id="skills-grid"></div>

  <div class="action-row">
    <button class="btn btn-gray" id="btn-basic" onclick="doBasic()">
      âš” ê¸°ë³¸ê³µê²©<br>
      <span id="basic-preview" style="font-size:10px;color:var(--blue)">DMG: -</span>
    </button>
    <button class="btn btn-gray" id="btn-defend" onclick="doDefend()">
      ğŸ›¡ ë°©ì–´<br>
      <span style="font-size:10px;color:var(--muted)">DEF+8 (1í„´)</span>
    </button>
    <button class="btn btn-gray" id="btn-hp-pot" onclick="useHpPot()">
      ğŸ§ª HPí¬ì…˜<br>
      <span id="hpot-cnt" style="font-size:10px;color:var(--muted)">0ê°œ</span>
    </button>
    <button class="btn btn-gray" id="btn-mp-pot" onclick="useMpPot()">
      ğŸ’§ MPí¬ì…˜<br>
      <span id="mpot-cnt" style="font-size:10px;color:var(--muted)">0ê°œ</span>
    </button>
  </div>

  <div class="log-box" id="log-box"></div>
</div>

<!-- ìƒì  -->
<div class="screen" id="screen-shop">
  <div class="shop-header">
    <div class="shop-title">ğŸª ìƒì </div>
    <div class="shop-gold">ğŸ’° <span id="shop-gold">0</span>G</div>
  </div>
  <div class="shop-player-bar" id="shop-player-bar"></div>

  <div class="shop-sec">ğŸ§ª ì†Œëª¨í’ˆ</div>
  <div class="potion-row">
    <div class="pot-card">
      <div class="pot-icon">ğŸ§ª</div>
      <div class="pot-name">HP í¬ì…˜</div>
      <div class="pot-eff">HP 40% ì¦‰ì‹œ íšŒë³µ</div>
      <div class="pot-cnt">ë³´ìœ  <span id="shop-hpot">0</span>ê°œ</div>
      <button class="btn btn-gold" style="width:100%;font-size:12px;padding:7px" id="shop-btn-hp" onclick="shopBuyHp()">20G êµ¬ë§¤</button>
    </div>
    <div class="pot-card">
      <div class="pot-icon">ğŸ’§</div>
      <div class="pot-name">MP í¬ì…˜</div>
      <div class="pot-eff">MP 50% ì¦‰ì‹œ íšŒë³µ</div>
      <div class="pot-cnt">ë³´ìœ  <span id="shop-mpot">0</span>ê°œ</div>
      <button class="btn btn-blue" style="width:100%;font-size:12px;padding:7px" id="shop-btn-mp" onclick="shopBuyMp()">15G êµ¬ë§¤</button>
    </div>
  </div>

  <div class="shop-sec">âš” ì¥ë¹„</div>
  <div class="shop-grid" id="shop-grid"></div>

  <div style="display:flex;gap:8px;margin-top:6px;">
    <button class="btn btn-gold" style="flex:1;padding:13px;font-size:14px" onclick="shopNext()">ë‹¤ìŒ ìŠ¤í…Œì´ì§€ â†’</button>
    <button class="btn btn-gray" style="padding:13px 14px" onclick="goTitle()">ğŸ </button>
  </div>
</div>

<!-- ê²°ê³¼ (íŒ¨ë°°) -->
<div class="screen" id="screen-result">
  <div class="result-big result-lose">DEFEAT</div>
  <div id="r-msg" style="color:var(--muted);font-size:13px;margin-bottom:4px"></div>
  <div class="result-card" id="r-card"></div>
  <button class="btn btn-gray" style="width:100%;margin-top:4px" onclick="goTitle()">ì²˜ìŒìœ¼ë¡œ</button>
</div>

<!-- ì—”ë”© -->
<div class="screen" id="screen-ending">
  <div style="text-align:center;padding-top:16px;">
    <div style="font-size:52px;margin-bottom:8px">ğŸ‰</div>
    <div id="ending-title" style="font-size:32px;font-weight:900;color:var(--gold);margin-bottom:4px">CLEAR!</div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:20px">ë˜ì „ì„ ì •ë³µí–ˆìŠµë‹ˆë‹¤!</div>
    <div class="result-card" id="ending-card" style="text-align:left;margin-bottom:16px"></div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:16px">
      ğŸ† ë‹¹ì‹ ì€ ì§„ì •í•œ ë˜ì „ ë¸Œë ˆì´ì»¤ì…ë‹ˆë‹¤!
    </div>
    <button class="btn btn-gold" style="width:100%;padding:14px;font-size:15px" onclick="goTitle()">ì²˜ìŒìœ¼ë¡œ</button>
  </div>
</div>

</div>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ë°ì´í„° â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const CLASSES=[
  { name:'ì „ì‚¬',  icon:'âš”ï¸', hp:150,mp:40,  atk:20,def:10, hpG:22,atkG:3,defG:2,mpG:4,
    skills:[
      {name:'ê°•íƒ€',    icon:'âš”ï¸',mp:8, cd:0,maxCd:2, type:'dmg',  mult:2.2,          desc:'ë‹¨ì¼ ATKÃ—2.2'},
      {name:'ë°©íŒ¨ëŒì§„', icon:'ğŸ›¡',mp:10,cd:0,maxCd:3, type:'dmg',  mult:1.6,selfBuff:{defB:7,t:2}, desc:'ATKÃ—1.6 + DEF+7 (2í„´)'},
      {name:'íšŒì˜¤ë¦¬',  icon:'ğŸŒ€',mp:15,cd:0,maxCd:4, type:'all',  mult:0.9,          desc:'ì „ì²´ ATKÃ—0.9'},
      {name:'ì „íˆ¬í•¨ì„±', icon:'ğŸ“£',mp:12,cd:0,maxCd:4, type:'buff', buff:{atkB:8,t:3}, desc:'ATK+8 (3í„´)'},
    ]
  },
  { name:'ë§ˆë²•ì‚¬', icon:'ğŸ”®', hp:90,mp:120, atk:10,def:3,  hpG:14,atkG:2,defG:1,mpG:18,
    skills:[
      {name:'íŒŒì´ì–´ë³¼', icon:'ğŸ”¥',mp:14,cd:0,maxCd:1, type:'dmg', mult:2.45,bonus:6,  desc:'ë‹¨ì¼ ATKÃ—2.45+6'},
      {name:'ë¸”ë¦¬ìë“œ', icon:'â„ï¸',mp:22,cd:0,maxCd:4, type:'all', mult:1.8,          desc:'ì „ì²´ ATKÃ—1.8'},
      {name:'ë²ˆê°œ',    icon:'âš¡',mp:28,cd:0,maxCd:5, type:'dmg', mult:5.0,bonus:12,  desc:'ë‹¨ì¼ ATKÃ—5.0+12'},
      {name:'ë§ˆë‚˜í¡ìˆ˜', icon:'ğŸ’œ',mp:0, cd:0,maxCd:4, type:'heal_mp',healMp:40,       desc:'MP +40'},
    ]
  },
  { name:'ë„ì ',  icon:'ğŸ—¡ï¸', hp:100,mp:70,  atk:18,def:5,  hpG:13,atkG:4,defG:1,mpG:9,
    skills:[
      {name:'ì´ì¤‘ì°Œë¥´ê¸°',icon:'ğŸ—¡ï¸',mp:10,cd:0,maxCd:1, type:'multi',mult:1.3,hits:2, desc:'ATKÃ—1.3 Ã—2íƒ€'},
      {name:'ë…ë‹¨ê²€',   icon:'â˜ ï¸',mp:14,cd:0,maxCd:2, type:'dmg',  mult:1.6,poison:true, desc:'ATKÃ—1.6 + ë…(3í„´)'},
      {name:'ì—°ë§‰íƒ„',   icon:'ğŸ’¨',mp:18,cd:0,maxCd:3, type:'buff', buff:{dodge:.5,t:2}, desc:'íšŒí”¼ 50% (2í„´)'},
      {name:'ì•”ì‚´',     icon:'ğŸŒ‘',mp:45,cd:0,maxCd:6, type:'dmg',  mult:6.0,          desc:'ë‹¨ì¼ ATKÃ—6.0'},
    ]
  },
  // â•â• ë±€íŒŒì´ì–´ (ì‹ ê·œ) â•â•
  { name:'ë±€íŒŒì´ì–´', icon:'ğŸ§›', hp:110,mp:80, atk:19,def:6, hpG:16,atkG:3,defG:1,mpG:10,
    isVampire:true,
    // í˜ˆê¸°(blood) ì‹œìŠ¤í…œ: ê³µê²©/í”¼í•´ ì‹œ ì¶©ì „, í˜ˆê¸° ìŠ¤í‚¬ë¡œ ì†Œëª¨
    maxBlood:100, blood:0,
    skills:[
      // í¡í˜ˆ - ë°ë¯¸ì§€ì˜ 20% ì²´ë ¥ í¡ìˆ˜
      {name:'í¡í˜ˆ',       icon:'ğŸ©¸',mp:12,cd:0,maxCd:2, type:'drain',   mult:2.0, drainRatio:0.4, desc:'ATKÃ—2.0, í”¼í•´ì˜ 40% í¡ìˆ˜'},
      // í˜ˆê¸° í­ë°œ - í˜ˆê¸° 50 ì†Œëª¨, ê°•ë ¥í•œ ê´‘ì—­
      {name:'í˜ˆê¸° í­ë°œ',  icon:'ğŸ’¥',mp:20,cd:0,maxCd:4, type:'blood_burst', mult:1.4, bloodCost:50, desc:'í˜ˆê¸°50 ì†Œëª¨ Â· ì „ì²´ ATKÃ—1.4'},
      // ë°•ì¥ êµ°ë‹¨ - ì „ì²´ í¡í˜ˆ 10%
      {name:'ë°•ì¥ êµ°ë‹¨',  icon:'ğŸ¦‡',mp:24,cd:0,maxCd:4, type:'drain_all',mult:1.2, drainRatio:0.3, desc:'ì „ì²´ ATKÃ—1.2, ê° 30% í¡ìˆ˜'},
      // ë¶ˆì‚¬ì˜ í”¼ - í˜ˆê¸° 100 ì†Œëª¨, HP 60% íšŒë³µ, ì¿¨íƒ€ì„ 8í„´
      {name:'ë¶ˆì‚¬ì˜ í”¼',  icon:'ğŸŒ‘',mp:0, cd:0,maxCd:8, type:'blood_heal', bloodCost:70, healRatio:0.60, desc:'í˜ˆê¸°70 ì†Œëª¨ Â· HP 60% íšŒë³µ'},
    ]
  },
];

const ENEMIES=[
  {name:'ìŠ¬ë¼ì„',     icon:'ğŸŸ¢', hp:30,  atk:6,  def:0,  exp:14,  gold:5},
  {name:'ê³ ë¸”ë¦°',     icon:'ğŸ‘º', hp:48,  atk:11, def:2,  exp:24,  gold:9},
  {name:'í•´ê³¨ì „ì‚¬',   icon:'ğŸ’€', hp:65,  atk:15, def:4,  exp:38,  gold:14},
  {name:'ì˜¤í¬',       icon:'ğŸ‘¹', hp:95,  atk:19, def:6,  exp:55,  gold:21},
  {name:'íŠ¸ë¡¤',       icon:'ğŸ§Ÿ', hp:140, atk:24, def:9,  exp:80,  gold:30},
  {name:'ë“œë˜ê³¤',     icon:'ğŸ‰', hp:230, atk:34, def:14, exp:170, gold:70},
  {name:'ë‹¤í¬ë‚˜ì´íŠ¸',  icon:'ğŸ—¡ï¸', hp:180, atk:28, def:11, exp:130, gold:50},
  {name:'ë§ˆì™•',       icon:'ğŸ‘¿', hp:220, atk:42, def:18, exp:300, gold:120},
  {name:'ê³¨ë ˜',       icon:'ğŸª¨', hp:260, atk:22, def:20, exp:150, gold:55},
  {name:'ë¶ˆì‚¬ì¡°',     icon:'ğŸ¦…', hp:200, atk:36, def:12, exp:160, gold:65},
];

const STAGE_CFG=[
  [0,0],[1,1],[1,2],[2,2,2],[3,7],
  [3,3,2],[4,4],[4,4,3],[5,3],[5,7],
  [6,6],[6,4,4],[8,3],[9,6],[7,8],
  [5,5,3],[6,9],[8,8],[5,6,9],[7,7,5],
];
const FINAL_STAGE=19;

const ITEMS=[
  {id:'sw1',name:'ë‚¡ì€ ê²€',    icon:'ğŸ—¡ï¸',slot:'weapon',atk:5,  def:0,  cost:20},
  {id:'sw2',name:'ê°•ì²  ê²€',    icon:'âš”ï¸', slot:'weapon',atk:13, def:0,  cost:65},
  {id:'sw3',name:'ë§ˆë²• ê²€',    icon:'âœ¨', slot:'weapon',atk:24, def:0,  cost:150},
  {id:'ar1',name:'ê°€ì£½ ê°‘ì˜·',  icon:'ğŸ¥‹', slot:'armor', atk:0,  def:6,  cost:20},
  {id:'ar2',name:'ì‚¬ìŠ¬ ê°‘ì˜·',  icon:'ğŸ›¡', slot:'armor', atk:0,  def:14, cost:65},
  {id:'ar3',name:'íŒê¸ˆ ê°‘ì˜·',  icon:'ğŸ°', slot:'armor', atk:0,  def:25, cost:150},
  {id:'rg1',name:'í˜ì˜ ë°˜ì§€',  icon:'ğŸ’', slot:'ring',  atk:7,  def:3,  cost:55},
  {id:'am1',name:'ìˆ˜í˜¸ ëª©ê±¸ì´',icon:'ğŸ“¿', slot:'amulet',atk:4,  def:9,  cost:55},
];
const SLOT_LABEL={weapon:'ë¬´ê¸°',armor:'ë°©ì–´êµ¬',ring:'ë°˜ì§€',amulet:'ëª©ê±¸ì´'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìƒíƒœ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let classIdx=0, player=null, enemies=[], stage=0;
let targetIdx=0, gold=0, hpPots=3, mpPots=2;
let equipped={weapon:null,armor:null,ring:null,amulet:null};
let owned=[];
let buffs={};
let defending=false;
let playerTurn=true, busy=false;
let luQueue=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• íƒ€ì´í‹€ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(function(){
  const row=document.getElementById('class-row');
  CLASSES.forEach((c,i)=>{
    const d=document.createElement('div');
    d.className='cls-card'+(c.isVampire?' vampire-card':'')+(i===0?' sel':'');
    d.innerHTML=`<div class="cls-icon">${c.icon}</div>
      <div class="cls-name">${c.name}</div>
      <div class="cls-desc">HP ${c.hp}  ATK ${c.atk}  DEF ${c.def}${c.isVampire?`<br>MP ${c.mp} Â· ğŸ©¸ í˜ˆê¸° ì‹œìŠ¤í…œ`:'<br>MP '+c.mp}</div>`;
    d.onclick=()=>{
      classIdx=i;
      document.querySelectorAll('.cls-card').forEach(x=>x.classList.remove('sel'));
      d.classList.add('sel');
    };
    row.appendChild(d);
  });
})();

function startGame(){
  const c=CLASSES[classIdx];
  player={
    name:c.name,icon:c.icon,
    hp:c.hp,maxHp:c.hp,mp:c.mp,maxMp:c.mp,
    atk:c.atk,def:c.def,lv:1,exp:0,expNext:30,
    skills:JSON.parse(JSON.stringify(c.skills)),
    hpG:c.hpG,atkG:c.atkG,defG:c.defG,mpG:c.mpG,
    isVampire:c.isVampire||false,
    blood: c.isVampire ? 0 : undefined,
    maxBlood: c.isVampire ? c.maxBlood : undefined,
  };
  gold=0; hpPots=3; mpPots=2; stage=0;
  equipped={weapon:null,armor:null,ring:null,amulet:null};
  owned=[]; buffs={}; luQueue=[];

  // ë±€íŒŒì´ì–´ UI í…Œë§ˆ ì„¤ì •
  applyVampireTheme(player.isVampire);

  showScreen('battle');
  loadStage();
}

function applyVampireTheme(isVampire){
  const pc=document.getElementById('player-card');
  const bloodContainer=document.getElementById('blood-bar-container');
  const hpTrack=document.getElementById('hp-track');
  const mpTrack=document.getElementById('mp-track');
  const mpLabel=document.getElementById('mp-label');

  if(isVampire){
    pc.classList.add('vampire-theme');
    bloodContainer.style.display='block';
    hpTrack.classList.add('vampire-bar');
    mpTrack.classList.add('vampire-bar');
    mpLabel.textContent='MP';
  } else {
    pc.classList.remove('vampire-theme');
    bloodContainer.style.display='none';
    hpTrack.classList.remove('vampire-bar');
    mpTrack.classList.remove('vampire-bar');
    mpLabel.textContent='MP';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìŠ¤í…Œì´ì§€ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadStage(){
  defending=false; buffs={}; busy=false; playerTurn=true; victoryPending=false; victoryDone=false;
  const cfg=STAGE_CFG[Math.min(stage, FINAL_STAGE)];
  const sc=1+stage*0.12;
  enemies=cfg.map((ei,i)=>{
    const t=ENEMIES[ei];
    return{
      ...t,
      hp:Math.floor(t.hp*sc), maxHp:Math.floor(t.hp*sc),
      atk:Math.floor(t.atk*(1+stage*.08)),
      def:Math.floor(t.def*(1+stage*.07)),
      exp:Math.floor(t.exp*(1+stage*.06)),
      gold:Math.floor(t.gold*(1+stage*.06)),
      poison:null, id:i,
    };
  });

  const bossStages=[4,9,14,19];
  const isBoss=bossStages.includes(stage);
  const badge=document.getElementById('stage-badge');
  badge.textContent=`STAGE ${stage+1}${isBoss?' ğŸ‘¿BOSS':''}`;
  badge.style.borderColor=isBoss?'#e05050':'#b8860b';
  badge.style.color=isBoss?'#e05050':'var(--gold)';

  targetIdx=0;
  player.skills.forEach(s=>{if(s.cd>0)s.cd--;});
  clearLog();
  addLog(`${isBoss?'ğŸ‘¿ BOSS':'âš”'} STAGE ${stage+1} ì‹œì‘! ì  ${enemies.length}ë§ˆë¦¬!`, isBoss?'e':'s');
  if(player.isVampire) addLog('ğŸ©¸ ê³µê²© ì‹œ í˜ˆê¸°ê°€ ì¶©ì „ë©ë‹ˆë‹¤!','v');
  renderAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• í˜ˆê¸° ì‹œìŠ¤í…œ (ë±€íŒŒì´ì–´) â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gainBlood(amount){
  if(!player.isVampire) return;
  player.blood=Math.min(player.maxBlood, player.blood+amount);
  updateHud();
}

function spendBlood(amount){
  if(!player.isVampire) return false;
  if(player.blood<amount) return false;
  player.blood-=amount;
  updateHud();
  return true;
}

// í”¼í•´ë¥¼ ì…ì„ ë•Œ í˜ˆê¸° ì†ŒëŸ‰ ì¶©ì „ (ê³ í†µì—ì„œ í˜ì„ ì–»ëŠ” ë±€íŒŒì´ì–´)
function onPlayerHit(dmg){
  if(player.isVampire){
    const gain=Math.max(3, Math.floor(dmg*0.3));
    gainBlood(gain);
    addLog(`ğŸ©¸ í”¼í•´ë¡œ í˜ˆê¸° +${gain} (${player.blood}/${player.maxBlood})`,'v');
  }
}

// í¡í˜ˆ ì²˜ë¦¬
function drainHeal(dmg, ratio){
  const heal=Math.max(1, Math.floor(dmg*ratio));
  player.hp=Math.min(player.maxHp, player.hp+heal);
  // í˜ˆê¸°ë„ ì¶©ì „
  gainBlood(Math.floor(heal*0.4));
  updateHud();
  return heal;
}

// í¡í˜ˆ í”Œë¡œíŒ… í…ìŠ¤íŠ¸ (í”Œë ˆì´ì–´ ì¹´ë“œ ìœ„)
function showDrainFloat(heal){
  const pc=document.getElementById('player-card');
  const rect=pc.getBoundingClientRect();
  const el=document.createElement('div');
  el.className='float-heal';
  el.textContent=`ğŸ©¸+${heal}`;
  el.style.left=(rect.left+rect.width/2)+'px';
  el.style.top=(rect.top+window.scrollY-10)+'px';
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì „íˆ¬ ì•¡ì…˜ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doBasic(){
  if(!canAct()) return;
  const en=getTarget(); if(!en) return;
  const dmg=calcDmg(effAtk()*0.8, en.def);
  const mpReg=Math.max(1,Math.floor(player.maxMp*.06));
  dealDmg(en, dmg);
  player.mp=Math.min(player.maxMp,player.mp+mpReg);
  // ë±€íŒŒì´ì–´: ê¸°ë³¸ ê³µê²©ì—ë„ í˜ˆê¸° ì†ŒëŸ‰ ì¶©ì „
  if(player.isVampire){
    const bg=Math.max(1, Math.floor(dmg*0.1));
    gainBlood(bg);
    addLog(`âš” ê¸°ë³¸ ê³µê²© â†’ ${en.name} ${dmg} ë°ë¯¸ì§€ / MP+${mpReg} / ğŸ©¸í˜ˆê¸°+${bg}`,'p');
  } else {
    addLog(`âš” ê¸°ë³¸ ê³µê²© â†’ ${en.name} ${dmg} ë°ë¯¸ì§€ / MP +${mpReg}`,'p');
  }
  tryEndPlayerTurn();
}

function doDefend(){
  if(!canAct()) return;
  defending=true;
  buffs.defB=(buffs.defB||0)+8;
  buffs.defTurns=2;
  addLog('ğŸ›¡ ë°©ì–´ íƒœì„¸! DEF +8 (ë‹¤ìŒ í„´ê¹Œì§€)','p');
  tryEndPlayerTurn();
}

function useHpPot(){
  if(!canAct()||hpPots<=0) return;
  const h=Math.floor(player.maxHp*.4);
  player.hp=Math.min(player.maxHp,player.hp+h);
  hpPots--;
  addLog(`ğŸ§ª HP í¬ì…˜! +${h} íšŒë³µ (ë‚¨ì€ ${hpPots}ê°œ)`,'h');
  updateHud(); setActionBtns();
  tryEndPlayerTurn();
}

function useMpPot(){
  if(!canAct()||mpPots<=0) return;
  const h=Math.floor(player.maxMp*.5);
  player.mp=Math.min(player.maxMp,player.mp+h);
  mpPots--;
  addLog(`ğŸ’§ MP í¬ì…˜! +${h} íšŒë³µ (ë‚¨ì€ ${mpPots}ê°œ)`,'h');
  updateHud(); setActionBtns();
  tryEndPlayerTurn();
}

function useSkill(idx){
  if(!canAct()) return;
  const sk=player.skills[idx];
  if(sk.cd>0||player.mp<sk.mp) return;

  // í˜ˆê¸° ì†Œëª¨ ìŠ¤í‚¬ ì²´í¬
  if(sk.bloodCost&&(!player.isVampire||player.blood<sk.bloodCost)){
    addLog(`ğŸ©¸ í˜ˆê¸° ë¶€ì¡±! (í•„ìš”: ${sk.bloodCost} / ë³´ìœ : ${player.blood||0})`,'v');
    return;
  }

  player.mp=Math.max(0,player.mp-sk.mp);
  sk.cd=sk.maxCd;

  // â”€â”€ ë±€íŒŒì´ì–´ ì „ìš© ìŠ¤í‚¬ â”€â”€
  if(sk.type==='drain'){
    // í¡í˜ˆ: ë‹¨ì¼ ê³µê²© + HP í¡ìˆ˜ + í˜ˆê¸° ì¶©ì „
    const en=getTarget(); if(!en) return;
    const dmg=calcDmg(effAtk()*(sk.mult||1), en.def);
    dealDmg(en, dmg);
    const heal=drainHeal(dmg, sk.drainRatio);
    showDrainFloat(heal);
    gainBlood(Math.max(8, Math.floor(dmg*0.35)));
    addLog(`ğŸ©¸ ${sk.name} â†’ ${en.name} ${dmg} ë°ë¯¸ì§€ / HP +${heal} í¡ìˆ˜!`,'v');

  } else if(sk.type==='drain_all'){
    // ë°•ì¥ êµ°ë‹¨: ì „ì²´ ê³µê²© + ê°ê° í¡ìˆ˜
    let totalDmg=0, totalHeal=0;
    enemies.forEach(en=>{
      if(en.hp<=0) return;
      const dmg=calcDmg(effAtk()*(sk.mult||1), en.def);
      dealDmg(en, dmg);
      totalDmg+=dmg;
      totalHeal+=drainHeal(dmg, sk.drainRatio);
    });
    showDrainFloat(totalHeal);
    gainBlood(Math.max(12, Math.floor(totalDmg*0.25)));
    addLog(`ğŸ¦‡ ${sk.name} â†’ ì „ì²´ ${totalDmg} ë°ë¯¸ì§€ / HP +${totalHeal} í¡ìˆ˜!`,'v');

  } else if(sk.type==='blood_burst'){
    // í˜ˆê¸° í­ë°œ: í˜ˆê¸° ì†Œëª¨ + ì „ì²´ ê°•ë ¥ ê³µê²©
    spendBlood(sk.bloodCost);
    let tot=0;
    enemies.forEach(en=>{
      if(en.hp<=0) return;
      const dmg=calcDmg(effAtk()*(sk.mult||1)+(player.blood*0.3), en.def);
      dealDmg(en,dmg); tot+=dmg;
    });
    addLog(`ğŸ’¥ ${sk.name} â†’ í˜ˆê¸° ${sk.bloodCost} ì†Œëª¨! ì „ì²´ ${tot} ë°ë¯¸ì§€!`,'v');

  } else if(sk.type==='blood_heal'){
    // ë¶ˆì‚¬ì˜ í”¼: í˜ˆê¸° ì†Œëª¨ + ëŒ€ê·œëª¨ HP íšŒë³µ
    spendBlood(sk.bloodCost);
    const heal=Math.floor(player.maxHp*(sk.healRatio||0.35));
    player.hp=Math.min(player.maxHp, player.hp+heal);
    showDrainFloat(heal);
    updateHud();
    addLog(`ğŸŒ‘ ${sk.name} â†’ í˜ˆê¸° ${sk.bloodCost} ì†Œëª¨! HP +${heal} íšŒë³µ!`,'v');

  // â”€â”€ ê¸°ì¡´ ìŠ¤í‚¬ â”€â”€
  } else if(sk.type==='dmg'||sk.type==='multi'){
    const en=getTarget(); if(!en) return;
    const hits=sk.hits||1;
    for(let h=0;h<hits;h++){
      if(en.hp<=0) break;
      const dmg=calcDmg(effAtk()*(sk.mult||1)+(sk.bonus||0), en.def);
      dealDmg(en,dmg);
    }
    const totalDmg=calcPreview(sk,en);
    addLog(`${sk.icon} ${sk.name} â†’ ${en.name} ${totalDmg} ë°ë¯¸ì§€!`,'p');
    if(en.hp>0&&sk.poison){ en.poison={dmg:Math.floor(effAtk()*.35),turns:3}; addLog(`â˜  ë… ë¶€ì—¬!`,'p'); }
    if(sk.selfBuff){ Object.assign(buffs,{defB:(buffs.defB||0)+sk.selfBuff.defB, defTurns:sk.selfBuff.t}); }

  } else if(sk.type==='all'){
    let tot=0;
    enemies.forEach(en=>{
      if(en.hp<=0) return;
      const dmg=calcDmg(effAtk()*(sk.mult||1), en.def);
      dealDmg(en,dmg); tot+=dmg;
    });
    addLog(`${sk.icon} ${sk.name} â†’ ì „ì²´ ê³µê²©! ì´ ${tot} ë°ë¯¸ì§€`,'p');

  } else if(sk.type==='buff'){
    Object.assign(buffs,{...sk.buff, turns:sk.buff.t});
    addLog(`${sk.icon} ${sk.name} â†’ ë²„í”„ ë°œë™!`,'p');

  } else if(sk.type==='heal_mp'){
    player.mp=Math.min(player.maxMp,player.mp+(sk.healMp||0));
    addLog(`${sk.icon} ${sk.name} â†’ MP +${sk.healMp}`,'h');
  }

  updateHud(); renderSkills();
  tryEndPlayerTurn();
}

function tryEndPlayerTurn(){
  if(enemies.every(e=>e.hp<=0)){
    victoryPending=false;
    busy=true; playerTurn=false;
    setTurnBadge(false); setActionBtns(); renderSkills();
    setTimeout(onVictory, 400);
  } else {
    endPlayerTurn();
  }
}

function dealDmg(en, dmg){
  en.hp=Math.max(0,en.hp-dmg);
  showFloat(en.id,dmg,'#e05050');
  renderEnemies();
  if(en.hp<=0) onKill(en);
}

function onKill(en){
  addLog(`ğŸ’¥ ${en.name} ì²˜ì¹˜!`,'s');
  gold+=en.gold;
  gainExp(en.exp);
  if(enemies.every(e=>e.hp<=0)){
    victoryPending=true;
  }
}

let victoryPending=false;
let victoryDone=false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ì  í„´ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function endPlayerTurn(){
  playerTurn=false; busy=true;
  setTurnBadge(false);
  setActionBtns();
  renderSkills();

  if(buffs.turns!==undefined){ buffs.turns--; if(buffs.turns<=0){ delete buffs.atkB; delete buffs.dodge; delete buffs.turns; } }
  if(buffs.defTurns!==undefined){ buffs.defTurns--; if(buffs.defTurns<=0){ delete buffs.defB; delete buffs.defTurns; } }

  if(victoryPending || enemies.every(e=>e.hp<=0)){
    victoryPending=false;
    setTimeout(onVictory, 400);
    return;
  }

  const alive=enemies.filter(e=>e.hp>0);
  let delay=0;
  alive.forEach(en=>{
    setTimeout(()=>{
      if(player.hp<=0) return;
      if(en.poison){
        const pdmg=en.poison.dmg;
        en.hp-=pdmg;
        addLog(`â˜  ${en.name} ë… ${pdmg}`,'x');
        showFloat(en.id,pdmg,'#9b59b6');
        renderEnemies();
        if(en.hp<=0){addLog(`ğŸ’¥ ${en.name} ë…ìœ¼ë¡œ ì²˜ì¹˜!`,'s'); gold+=en.gold; gainExp(en.exp);
          if(enemies.every(e=>e.hp<=0)){ setTimeout(onVictory,400); return; }
          return;}
      }
      if(buffs.dodge&&Math.random()<buffs.dodge){
        addLog(`ğŸ’¨ ${en.name} ê³µê²© íšŒí”¼!`,'p'); return;
      }
      const def=effDef();
      const dmg=Math.max(1, en.atk-def+rnd(-2,3));
      player.hp=Math.max(0,player.hp-dmg);
      addLog(`ğŸ‘Š ${en.name} â†’ ${dmg} ë°ë¯¸ì§€`,'e');

      // ë±€íŒŒì´ì–´: í”¼ê²© ì‹œ í˜ˆê¸° ì¶©ì „
      onPlayerHit(dmg);

      const pc=document.querySelector('.player-card');
      pc.classList.remove('do-shake'); void pc.offsetWidth; pc.classList.add('do-shake');
      updateHud();
      if(player.hp<=0){ setTimeout(onDefeat,300); }
    },delay);
    delay+=600;
  });

  setTimeout(()=>{
    if(player.hp<=0) return;
    startPlayerTurn();
  },delay+200);
}

function startPlayerTurn(){
  playerTurn=true; busy=false; defending=false;
  player.skills.forEach(s=>{if(s.cd>0)s.cd--;});
  enemies.forEach(en=>{
    if(en.hp<=0||!en.poison) return;
    en.poison.turns--;
    if(en.poison.turns<=0) en.poison=null;
  });
  setTurnBadge(true);
  renderAll();
  addLog('â”€â”€ ë‚´ í„´','s');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìŠ¹íŒ¨ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onVictory(){
  if(victoryDone) return;
  victoryDone=true;
  busy=true; playerTurn=false;
  addLog(`ğŸ‰ STAGE ${stage+1} í´ë¦¬ì–´!`,'s');
  if(stage===FINAL_STAGE){
    setTimeout(showEnding, 600);
  } else {
    setTimeout(showShop, 500);
  }
}

function showEnding(){
  const bloodInfo=player.isVampire ? `<div class="r-row"><span>ğŸ©¸ ìµœì¢… í˜ˆê¸°</span><span class="r-val">${player.blood}/${player.maxBlood}</span></div>` : '';
  document.getElementById('ending-card').innerHTML=`
    <div class="r-row"><span>ğŸ§™ ì§ì—…</span><span class="r-val">${player.icon} ${player.name}</span></div>
    <div class="r-row"><span>â­ ìµœì¢… ë ˆë²¨</span><span class="r-val">Lv ${player.lv}</span></div>
    <div class="r-row"><span>âš” ìµœì¢… ATK</span><span class="r-val">${effAtk()}</span></div>
    <div class="r-row"><span>ğŸ›¡ ìµœì¢… DEF</span><span class="r-val">${effDef()}</span></div>
    <div class="r-row"><span>â¤ ë‚¨ì€ HP</span><span class="r-val">${player.hp}/${player.maxHp}</span></div>
    ${bloodInfo}
    <div class="r-row"><span>ğŸ’° ì´ ê³¨ë“œ</span><span class="r-val">${gold}G</span></div>
  `;
  showScreen('ending');
}

function onDefeat(){
  busy=true; playerTurn=false;
  document.getElementById('r-msg').textContent=`STAGE ${stage+1}ì—ì„œ ì“°ëŸ¬ì¡ŒìŠµë‹ˆë‹¤...`;
  document.getElementById('r-card').innerHTML=`
    <div class="r-row"><span>ë„ë‹¬ ìŠ¤í…Œì´ì§€</span><span class="r-val">STAGE ${stage+1}</span></div>
    <div class="r-row"><span>ìµœì¢… ë ˆë²¨</span><span class="r-val">Lv ${player.lv}</span></div>
    <div class="r-row"><span>ì´ ê³¨ë“œ</span><span class="r-val">${gold}G</span></div>
  `;
  showScreen('result');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìƒì  â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showShop(){
  document.getElementById('shop-gold').textContent=gold;
  document.getElementById('shop-hpot').textContent=hpPots;
  document.getElementById('shop-mpot').textContent=mpPots;
  document.getElementById('shop-btn-hp').disabled=gold<20;
  document.getElementById('shop-btn-mp').disabled=gold<15;
  document.getElementById('shop-player-bar').innerHTML=`
    <span style="font-size:20px">${player.icon}</span>&nbsp;
    <strong>${player.name}</strong> Lv${player.lv} &nbsp;|&nbsp;
    â¤ ${player.hp}/${player.maxHp} &nbsp;
    âš” ATK ${effAtk()} &nbsp;
    ğŸ›¡ DEF ${effDef()}
    ${player.isVampire ? `&nbsp; ğŸ©¸ í˜ˆê¸° ${player.blood}/${player.maxBlood}` : `&nbsp;ğŸ’œ MP ${player.mp}/${player.maxMp}`}
  `;
  renderShopGrid();
  showScreen('shop');
}

function renderShopGrid(){
  const g=document.getElementById('shop-grid');
  g.innerHTML='';
  ITEMS.forEach(item=>{
    const isOwned=owned.includes(item.id);
    const isEq=Object.values(equipped).some(e=>e&&e.id===item.id);
    const canAff=gold>=item.cost;
    const d=document.createElement('div');
    d.className='shop-item'+(isEq?' is-equipped':!canAff&&!isOwned?' no-gold':'');
    const stats=[item.atk?`âš”+${item.atk}`:'',item.def?`ğŸ›¡+${item.def}`:''].filter(Boolean).join('  ');
    d.innerHTML=`
      <div class="si-head">
        <div class="si-icon">${item.icon}</div>
        <div><div class="si-name">${item.name}</div><div class="si-slot">${SLOT_LABEL[item.slot]}</div></div>
      </div>
      <div class="si-stat">${stats}</div>
      <div class="si-foot">
        ${isEq
          ? '<span style="color:var(--green);font-size:11px;font-weight:700">âœ… ì¥ì°©ì¤‘</span>'
          : isOwned
            ? `<span style="color:var(--green);font-size:11px">ë³´ìœ </span>
               <button class="btn btn-blue" style="font-size:11px;padding:4px 10px" onclick="shopEquip('${item.id}')">ì¥ì°©</button>`
            : canAff
              ? `<span class="si-price">${item.cost}G</span>
                 <button class="btn btn-gold" style="font-size:11px;padding:4px 10px" onclick="shopBuy('${item.id}')">êµ¬ë§¤</button>`
              : `<span style="color:#444;font-size:11px">${item.cost}G</span>
                 <span style="font-size:10px;color:#444">ë¶€ì¡±</span>`
        }
      </div>
    `;
    g.appendChild(d);
  });
}

function shopBuy(id){
  const item=ITEMS.find(i=>i.id===id);
  if(!item||gold<item.cost) return;
  gold-=item.cost;
  owned.push(item.id);
  equipped[item.slot]=item;
  document.getElementById('shop-gold').textContent=gold;
  document.getElementById('shop-btn-hp').disabled=gold<20;
  document.getElementById('shop-btn-mp').disabled=gold<15;
  document.getElementById('shop-player-bar').innerHTML=`
    <span style="font-size:20px">${player.icon}</span>&nbsp;
    <strong>${player.name}</strong> Lv${player.lv} &nbsp;|&nbsp;
    â¤ ${player.hp}/${player.maxHp} &nbsp;
    âš” ATK ${effAtk()} &nbsp;
    ğŸ›¡ DEF ${effDef()}
    ${player.isVampire ? `&nbsp; ğŸ©¸ ${player.blood}/${player.maxBlood}` : `&nbsp;ğŸ’œ MP ${player.mp}/${player.maxMp}`}
  `;
  renderShopGrid();
}
function shopEquip(id){
  const item=ITEMS.find(i=>i.id===id);
  if(!item) return;
  equipped[item.slot]=item;
  renderShopGrid();
}
function shopBuyHp(){
  if(gold<20) return;
  gold-=20; hpPots++;
  document.getElementById('shop-gold').textContent=gold;
  document.getElementById('shop-hpot').textContent=hpPots;
  document.getElementById('shop-btn-hp').disabled=gold<20;
  document.getElementById('shop-btn-mp').disabled=gold<15;
}
function shopBuyMp(){
  if(gold<15) return;
  gold-=15; mpPots++;
  document.getElementById('shop-gold').textContent=gold;
  document.getElementById('shop-mpot').textContent=mpPots;
  document.getElementById('shop-btn-hp').disabled=gold<20;
  document.getElementById('shop-btn-mp').disabled=gold<15;
}
function shopNext(){
  stage++;
  showScreen('battle');
  loadStage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ê²½í—˜ì¹˜ & ë ˆë²¨ì—… â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function gainExp(exp){
  player.exp+=exp;
  while(player.exp>=player.expNext){
    player.exp-=player.expNext;
    player.lv++;
    player.expNext=Math.floor(player.expNext*1.4);
    const h=player.hpG,a=player.atkG,d=player.defG,m=player.mpG;
    player.maxHp+=h; player.hp=Math.min(player.maxHp,player.hp+Math.floor(h/2));
    player.maxMp+=m; player.mp=Math.min(player.maxMp,player.mp+Math.floor(m/2));
    player.atk+=a; player.def+=d;
    // ë±€íŒŒì´ì–´ ë ˆë²¨ì—… ì‹œ ìµœëŒ€ í˜ˆê¸° ì¦ê°€
    if(player.isVampire){
      player.maxBlood+=10;
    }
    luQueue.push({lv:player.lv,h,a,d,m});
    addLog(`â¬† LEVEL UP! Lv ${player.lv}`,'s');
  }
  updateHud();
  if(luQueue.length) showLu();
}
function showLu(){
  if(!luQueue.length) return;
  const lu=luQueue.shift();
  document.getElementById('lu-lv').textContent=lu.lv;
  document.getElementById('lu-stats').innerHTML=`â¤ HP+${lu.h}&nbsp;&nbsp;âš” ATK+${lu.a}<br>ğŸ›¡ DEF+${lu.d}&nbsp;&nbsp;ğŸ’œ MP+${lu.m}${player.isVampire?'<br>ğŸ©¸ ìµœëŒ€í˜ˆê¸°+10':''}`;
  document.getElementById('lu-overlay').style.display='flex';
}
function closeLu(){
  document.getElementById('lu-overlay').style.display='none';
  if(luQueue.length) setTimeout(showLu,200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ìœ í‹¸ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function effAtk(){ return player.atk+(buffs.atkB||0)+(equipped.weapon?.atk||0)+(equipped.ring?.atk||0)+(equipped.amulet?.atk||0); }
function effDef(){ return player.def+(buffs.defB||0)+(equipped.armor?.def||0)+(equipped.ring?.def||0)+(equipped.amulet?.def||0); }
function calcDmg(base,def){ return Math.max(1,Math.floor(base-Math.max(0,def-2)+rnd(-3,4))); }
function rnd(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function canAct(){ return playerTurn&&!busy; }
function getTarget(){
  if(enemies[targetIdx]?.hp>0) return enemies[targetIdx];
  const i=enemies.findIndex(e=>e.hp>0);
  if(i>=0){ targetIdx=i; return enemies[i]; }
  return null;
}

function calcPreview(sk, en){
  if(!en||en.hp<=0) return '?';
  const atk=effAtk();
  if(sk.type==='dmg') return calcDmg(atk*(sk.mult||1)+(sk.bonus||0), en.def);
  if(sk.type==='multi') return `${calcDmg(atk*(sk.mult||1),en.def)}Ã—${sk.hits||2}`;
  if(sk.type==='drain'){
    const dmg=calcDmg(atk*(sk.mult||1), en.def);
    return `DMG:${dmg} / í¡:${Math.floor(dmg*(sk.drainRatio||0.6))}`;
  }
  if(sk.type==='drain_all'){
    const alive=enemies.filter(e=>e.hp>0);
    return `ì „ì²´ ${alive.length}ë§ˆë¦¬`;
  }
  if(sk.type==='all'){
    const alive=enemies.filter(e=>e.hp>0);
    return alive.map(e=>calcDmg(atk*(sk.mult||1),e.def)).join('+');
  }
  if(sk.type==='blood_heal'){
    return `HP+${Math.floor(player.maxHp*(sk.healRatio||0.35))}`;
  }
  return '-';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â• ë Œë”ë§ â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll(){
  renderEnemies();
  renderSkills();
  updateHud();
  setActionBtns();
}

function renderEnemies(){
  const z=document.getElementById('enemy-zone');
  z.innerHTML='';
  enemies.forEach((en,i)=>{
    const d=document.createElement('div');
    d.className='enemy-card'+(en.hp<=0?' dead':i===targetIdx?' targeted':'');
    d.id='en-'+i;
    d.innerHTML=`
      <div class="e-icon">${en.icon}</div>
      <div class="e-name">${en.name}</div>
      <div class="e-hpbar"><div class="e-hpfill" style="width:${Math.max(0,en.hp/en.maxHp*100)}%"></div></div>
      <div class="e-hp">${Math.max(0,en.hp)}/${en.maxHp}</div>
      ${en.poison?'<div class="e-status">â˜ ë…</div>':''}
      <div class="e-status" style="color:var(--muted)">ATK${en.atk} DEF${en.def}</div>
    `;
    d.onclick=()=>{ if(en.hp>0){ targetIdx=i; renderEnemies(); renderSkills(); updateHud(); } };
    z.appendChild(d);
  });
}

function renderSkills(){
  const g=document.getElementById('skills-grid');
  g.innerHTML='';
  const en=getTarget();
  player.skills.forEach((sk,i)=>{
    const onCd=sk.cd>0;
    const noMp=player.mp<sk.mp;
    const noBlood=sk.bloodCost&&player.blood<sk.bloodCost;
    const ok=canAct()&&!onCd&&!noMp&&!noBlood;
    const preview=calcPreview(sk,en);
    const isVampSkill=['drain','drain_all','blood_burst','blood_heal'].includes(sk.type);
    const bloodReady=isVampSkill&&ok&&sk.bloodCost&&player.blood>=sk.bloodCost;

    const btn=document.createElement('button');
    btn.className='skill-btn'+(isVampSkill?' vampire-skill':'')+(bloodReady?' blood-skill-available':'');
    btn.disabled=!ok;
    btn.innerHTML=`
      <div class="sk-icon">${sk.icon}</div>
      <div class="sk-info">
        <div class="sk-name">${sk.name}</div>
        <div class="sk-meta">${sk.desc} Â· MP${sk.mp}${sk.bloodCost?` Â· ğŸ©¸${sk.bloodCost}`:''}</div>
        ${onCd?`<div class="sk-cd">ì¿¨ë‹¤ìš´ ${sk.cd}í„´</div>`:
          noMp?`<div class="sk-cd">MP ë¶€ì¡±</div>`:
          noBlood?`<div class="sk-cd">ğŸ©¸ í˜ˆê¸° ë¶€ì¡± (${player.blood||0}/${sk.bloodCost})</div>`:
          `<div class="sk-preview${isVampSkill?' blood-preview':''}">${preview}</div>`}
      </div>
    `;
    btn.onclick=()=>useSkill(i);
    g.appendChild(btn);
  });
}

function updateHud(){
  const p=player;
  document.getElementById('p-avatar').textContent=p.icon;
  document.getElementById('p-name').textContent=p.name;
  document.getElementById('p-lv').textContent=p.lv;
  document.getElementById('hud-lv').textContent=p.lv;
  document.getElementById('p-hp').textContent=Math.max(0,p.hp);
  document.getElementById('p-mhp').textContent=p.maxHp;
  document.getElementById('p-mp').textContent=p.mp;
  document.getElementById('p-mmp').textContent=p.maxMp;
  document.getElementById('p-atk').textContent=effAtk();
  document.getElementById('p-def').textContent=effDef();
  document.getElementById('bar-hp').style.width=Math.max(0,p.hp/p.maxHp*100)+'%';
  document.getElementById('bar-mp').style.width=p.mp/p.maxMp*100+'%';
  document.getElementById('bar-exp').style.width=p.exp/p.expNext*100+'%';
  document.getElementById('exp-val').textContent=p.exp+'/'+p.expNext;

  // í˜ˆê¸° ê²Œì´ì§€ ì—…ë°ì´íŠ¸
  if(p.isVampire){
    document.getElementById('p-blood').textContent=p.blood;
    document.getElementById('p-mblood').textContent=p.maxBlood;
    document.getElementById('bar-blood').style.width=(p.blood/p.maxBlood*100)+'%';
    // í˜ˆê¸° ê²Œì´ì§€ ê¸€ë¡œìš°
    const bt=document.getElementById('blood-track');
    if(p.blood>=50) bt.classList.add('blood-ready');
    else bt.classList.remove('blood-ready');
  }

  const en=getTarget();
  if(en&&en.hp>0){
    const base=Math.floor(effAtk()*.8);
    const def=Math.max(0,en.def-2);
    const mn=Math.max(1,base-def-3), mx=Math.max(1,base-def+4);
    const mpReg=Math.max(1,Math.floor(p.maxMp*.06));
    if(p.isVampire){
      const bg=Math.max(3,Math.floor(((mn+mx)/2)*0.2));
      document.getElementById('basic-preview').textContent=`DMG: ${mn}~${mx} / ğŸ©¸+${bg}`;
    } else {
      document.getElementById('basic-preview').textContent=`DMG: ${mn}~${mx} / MP+${mpReg}`;
    }
  } else {
    document.getElementById('basic-preview').textContent='DMG: -';
  }
}

function setActionBtns(){
  const ok=canAct();
  document.getElementById('btn-basic').disabled=!ok;
  document.getElementById('btn-defend').disabled=!ok;
  document.getElementById('btn-hp-pot').disabled=!ok||hpPots<=0;
  document.getElementById('btn-mp-pot').disabled=!ok||mpPots<=0;
  document.getElementById('hpot-cnt').textContent=hpPots+'ê°œ';
  document.getElementById('mpot-cnt').textContent=mpPots+'ê°œ';
}

function setTurnBadge(myTurn){
  const b=document.getElementById('turn-badge');
  b.textContent=myTurn?'ë‚´ í„´':'ì  í„´';
  b.className='turn-badge'+(myTurn?'':' enemy-turn');
}

function addLog(msg,type=''){
  const b=document.getElementById('log-box');
  const el=document.createElement('div');
  el.className='log-'+type;
  el.textContent=msg;
  b.appendChild(el);
  b.scrollTop=b.scrollHeight;
  while(b.children.length>50) b.removeChild(b.firstChild);
}
function clearLog(){ document.getElementById('log-box').innerHTML=''; }

function showFloat(id,dmg,color){
  const card=document.getElementById('en-'+id);
  if(!card) return;
  const el=document.createElement('div');
  el.className='float-dmg'; el.style.color=color;
  el.textContent='-'+dmg;
  card.appendChild(el);
  setTimeout(()=>el.remove(),850);
}

function showScreen(name){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById('screen-'+name).classList.add('active');
}

function goTitle(){
  showScreen('title');
  applyVampireTheme(false);
}

function switchTutTab(idx){
  document.querySelectorAll('.tut-tab').forEach((t,i)=>t.classList.toggle('active',i===idx));
  document.querySelectorAll('.tut-page').forEach((p,i)=>p.classList.toggle('active',i===idx));
}
</script>
</body>
</html>
